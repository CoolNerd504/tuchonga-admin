// Prisma Schema for TuChonga Mobile App + Admin Dashboard
// Database: PostgreSQL
// Migrated from: Firebase Firestore

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USERS & AUTHENTICATION
// ============================================================================

model User {
  id String @id @default(uuid())

  // Authentication
  firebaseAuthId String? @unique // Firebase Auth UID (if migrated)
  email          String? @unique
  phoneNumber    String? @unique

  // Profile Information
  fullName     String?
  displayName  String?
  firstname    String? // User's first name
  lastname     String? // User's last name
  profileImage String?
  location     String?
  mobile       String? // Alternative to phoneNumber
  gender       String? // "male" | "female" | "other" | null

  // Profile Status
  hasCompletedProfile Boolean   @default(false)
  profileCompletedAt  DateTime?
  isActive            Boolean   @default(true)

  // Role
  role String @default("user") // "user" | "admin" | "super_admin" | "moderator" | "staff"

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  reviews          Review[]
  comments         Comment[]
  quickRatings     QuickRating[]
  favorites        Favorite[]
  commentReactions CommentReaction[]
  userAnalytics    UserAnalytics?
  staffProfile     Staff?
  adminAuth        AdminAuth?
  createdProducts  Product[]         @relation("ProductCreator")
  createdServices  Service[]         @relation("ServiceCreator")

  @@index([email])
  @@index([phoneNumber])
  @@index([role])
  @@index([createdAt])
  @@index([firstname])
  @@index([lastname])
}

// ============================================================================
// ADMIN AUTHENTICATION
// ============================================================================

model AdminAuth {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Password (hashed)
  passwordHash String

  // Security
  lastLoginAt   DateTime?
  loginAttempts Int       @default(0)
  lockedUntil   DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Staff {
  id     String @id @default(uuid())
  userId String @unique // Foreign key to User
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Staff-specific fields
  role     String // "Manager" | "Records" | "Customer Service"
  mobile   String?
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([role])
}

// ============================================================================
// USER ANALYTICS
// ============================================================================

model UserAnalytics {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Review Analytics
  totalReviews    Int       @default(0)
  productReviews  Int       @default(0)
  serviceReviews  Int       @default(0)
  reviewHistory   String[] // Array of review IDs
  lastReviewAt    DateTime?
  positiveReviews Int       @default(0)
  neutralReviews  Int       @default(0)
  negativeReviews Int       @default(0)

  // Comment Analytics
  totalComments   Int       @default(0)
  productComments Int       @default(0)
  serviceComments Int       @default(0)
  commentHistory  String[] // Array of comment IDs
  lastCommentAt   DateTime?
  totalReplies    Int       @default(0)
  totalAgrees     Int       @default(0)
  totalDisagrees  Int       @default(0)

  // Legacy Analytics
  totalCoSigns    Int @default(0)
  totalFiftyFifty Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([lastReviewAt])
  @@index([lastCommentAt])
}

// ============================================================================
// BUSINESSES
// ============================================================================

model Business {
  id String @id @default(uuid())

  // Business Information
  name          String
  businessEmail String? @unique
  businessPhone String?
  location      String?
  logo          String?

  // Point of Contact
  pocFirstname String?
  pocLastname  String?
  pocPhone     String?

  // Status
  isVerified Boolean @default(false)
  status     Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  products Product[]
  services Service[]

  @@index([name])
  @@index([businessEmail])
  @@index([isVerified])
  @@index([createdAt])
}

// ============================================================================
// CATEGORIES
// ============================================================================

model Category {
  id          String       @id @default(uuid())
  name        String       @unique
  description String?
  type        CategoryType @default(PRODUCT)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  products ProductCategory[]
  services ServiceCategory[]

  @@index([type])
  @@index([name])
}

enum CategoryType {
  PRODUCT
  SERVICE
}

// ============================================================================
// PRODUCTS
// ============================================================================

model Product {
  id String @id @default(uuid())

  // Basic Information
  productName      String
  description      String?
  mainImage        String?
  additionalImages String[] // Array of image URLs

  // Status
  isActive   Boolean @default(true)
  isVerified Boolean @default(false) // Admin verification status

  // Business Owner
  businessId   String?
  business     Business? @relation(fields: [businessId], references: [id], onDelete: SetNull)
  productOwner String? // Business name (denormalized for quick access)

  // Creator
  createdBy String? // User ID who created this product
  user      User?   @relation("ProductCreator", fields: [createdBy], references: [id], onDelete: SetNull)

  // Analytics
  totalViews      Int @default(0)
  totalReviews    Int @default(0)
  positiveReviews Int @default(0)
  neutralReviews  Int @default(0)
  negativeReviews Int @default(0)

  // Quick Rating
  quickRatingAvg   Float?
  quickRatingTotal Int    @default(0)
  quickRating1     Int    @default(0)
  quickRating2     Int    @default(0)
  quickRating3     Int    @default(0)
  quickRating4     Int    @default(0)
  quickRating5     Int    @default(0)

  // Timestamps
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  lastUpdate DateTime?

  // Relations
  categories   ProductCategory[]
  reviews      Review[]
  comments     Comment[]
  quickRatings QuickRating[]
  favorites    Favorite[]

  @@index([productName])
  @@index([businessId])
  @@index([isActive])
  @@index([isVerified])
  @@index([createdBy])
  @@index([createdAt])
  @@index([totalViews])
  @@index([quickRatingAvg])
}

model ProductCategory {
  productId  String
  categoryId String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([productId, categoryId])
  @@index([productId])
  @@index([categoryId])
}

// ============================================================================
// SERVICES
// ============================================================================

model Service {
  id String @id @default(uuid())

  // Basic Information
  serviceName      String
  description      String?
  mainImage        String?
  additionalImages String[] // Array of image URLs

  // Status
  isActive   Boolean @default(true)
  isVerified Boolean @default(false) // Admin verification status

  // Business Owner
  businessId   String?
  business     Business? @relation(fields: [businessId], references: [id], onDelete: SetNull)
  serviceOwner String? // Business name (denormalized)

  // Creator
  createdBy String? // User ID who created this service
  user      User?   @relation("ServiceCreator", fields: [createdBy], references: [id], onDelete: SetNull)

  // Analytics
  totalViews      Int @default(0)
  totalReviews    Int @default(0)
  positiveReviews Int @default(0)
  neutralReviews  Int @default(0)
  negativeReviews Int @default(0)

  // Quick Rating
  quickRatingAvg   Float?
  quickRatingTotal Int    @default(0)
  quickRating1     Int    @default(0)
  quickRating2     Int    @default(0)
  quickRating3     Int    @default(0)
  quickRating4     Int    @default(0)
  quickRating5     Int    @default(0)

  // Timestamps
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  lastUpdate DateTime?

  // Relations
  categories   ServiceCategory[]
  reviews      Review[]
  comments     Comment[]
  quickRatings QuickRating[]
  favorites    Favorite[]

  @@index([serviceName])
  @@index([businessId])
  @@index([isActive])
  @@index([isVerified])
  @@index([createdBy])
  @@index([createdAt])
  @@index([totalViews])
  @@index([quickRatingAvg])
}

model ServiceCategory {
  serviceId  String
  categoryId String
  service    Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([serviceId, categoryId])
  @@index([serviceId])
  @@index([categoryId])
}

// ============================================================================
// REVIEWS
// ============================================================================

model Review {
  id String @id @default(uuid())

  // User
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Item (Product or Service)
  productId String?
  serviceId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  service   Service? @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  // Review Content
  sentiment  ReviewSentiment
  text       String?
  reviewText String? // Alternative text field

  // History (JSON field for sentiment history)
  sentimentHistory Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([productId])
  @@index([serviceId])
  @@index([sentiment])
  @@index([createdAt])
}

enum ReviewSentiment {
  WOULD_RECOMMEND
  ITS_GOOD
  DONT_MIND_IT
  ITS_BAD
}

// ============================================================================
// COMMENTS
// ============================================================================

model Comment {
  id String @id @default(uuid())

  // User
  userId     String
  user       User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userName   String
  userAvatar String?

  // Item (Product or Service)
  itemId    String // Product or Service ID
  itemType  ItemType
  productId String?
  serviceId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  service   Service? @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  // Comment Content
  text String

  // Threading
  parentId String? // For replies (null for root comments)
  depth    Int     @default(0) // 0 = root, 1-2 = replies

  // Reactions
  agreeCount    Int @default(0)
  disagreeCount Int @default(0)
  replyCount    Int @default(0)

  // Status
  isEdited   Boolean @default(false)
  isReported Boolean @default(false)
  isDeleted  Boolean @default(false)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  editedAt  DateTime?

  // Relations
  reactions CommentReaction[]
  parent    Comment?          @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[]         @relation("CommentReplies")

  @@index([userId])
  @@index([itemId])
  @@index([itemType])
  @@index([productId])
  @@index([serviceId])
  @@index([parentId])
  @@index([isDeleted])
  @@index([createdAt])
}

enum ItemType {
  PRODUCT
  SERVICE
}

// ============================================================================
// COMMENT REACTIONS
// ============================================================================

model CommentReaction {
  id String @id @default(uuid())

  // User
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Comment
  commentId String
  comment   Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  // Reaction
  reactionType ReactionType

  // Timestamp
  createdAt DateTime @default(now())

  @@unique([userId, commentId]) // One reaction per user per comment
  @@index([userId])
  @@index([commentId])
  @@index([reactionType])
}

enum ReactionType {
  AGREE
  DISAGREE
}

// ============================================================================
// QUICK RATINGS (Emoji-based)
// ============================================================================

model QuickRating {
  id String @id @default(uuid())

  // User
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Item (Product or Service)
  itemId    String // Product or Service ID
  itemType  ItemType
  productId String?
  serviceId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  service   Service? @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  // Rating (1-5 emoji scale)
  rating Int // 1-5

  // Daily limit tracking
  lastUpdated DateTime @default(now())

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, itemId]) // One rating per user per item
  @@index([userId])
  @@index([itemId])
  @@index([itemType])
  @@index([productId])
  @@index([serviceId])
  @@index([rating])
}

// ============================================================================
// FAVORITES
// ============================================================================

model Favorite {
  id String @id @default(uuid())

  // User
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Item (Product or Service)
  itemId    String // Product or Service ID
  itemType  ItemType
  productId String?
  serviceId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  service   Service? @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  // Timestamp
  createdAt DateTime @default(now())

  @@unique([userId, itemId]) // One favorite per user per item
  @@index([userId])
  @@index([itemId])
  @@index([itemType])
  @@index([productId])
  @@index([serviceId])
  @@index([createdAt])
}

// ============================================================================
// OPTIONAL: SURVEYS (if exists in mobile app)
// ============================================================================

model Survey {
  id String @id @default(uuid())

  // User & Item
  userId   String
  itemId   String // Product or Service ID
  itemType ItemType

  // Survey Data
  surveyVersion  String
  responses      Json // Question ID -> Answer mapping
  overallRating  Int // 1-5 scale
  completionTime Int // Seconds
  isComplete     Boolean @default(false)

  // Source
  source String // "product-survey" | "service-survey"

  // Timestamp
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([itemId])
  @@index([itemType])
  @@index([createdAt])
}

model SurveyTemplate {
  id        String   @id @default(uuid())
  name      String
  version   String
  itemType  ItemType
  questions Json // Array of question objects

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, version])
  @@index([itemType])
}
